dockerfile
Copy
Download
FROM python:3.11-slim

WORKDIR /app

RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

RUN mkdir -p backend/uploads

EXPOSE 8000

CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
3.3 docker-compose.yml - Para desenvolvimento completo
Copy
Download
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - SECRET_KEY=${SECRET_KEY:-development-secret-key}
      - CSRF_SECRET_KEY=${CSRF_SECRET_KEY:-development-csrf-key}
      - DATABASE_URL=sqlite:///./closset.db
      - DEBUG=true
    volumes:
      - ./backend:/app
      - uploads_data:/app/backend/uploads
    command: uvicorn app:app --host 0.0.0.0 --port 8000 --reload

  frontend:
    build: ./frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:8000
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: npm run dev

volumes:
  uploads_data:
4. SCRIPT DE INSTALA√á√ÉO E CONFIGURA√á√ÉO
4.1 setup.sh - Script de instala√ß√£o automatizado
Copy
Download


echo "üöÄ Setting up Closet.IA with CSRF and JWT Security..."

if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 is not installed. Please install Python 3.8 or higher."
    exit 1
fi

if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js is not installed. Please install Node.js 16 or higher."
    exit 1
fi

echo "üìÅ Creating project structure..."
mkdir -p closset-ia/{backend/{services,uploads},frontend/src/{components,pages,contexts,services}}

echo "üîß Setting up backend..."
cd closset-ia/backend

python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

echo "üì¶ Installing Python dependencies..."
pip install --upgrade pip
pip install -r requirements.txt

echo "üîê Creating .env file..."
cat > .env << EOL
SECRET_KEY=$(openssl rand -hex 32)
CSRF_SECRET_KEY=$(openssl rand -hex 32)

DATABASE_URL=sqlite:///./closset.db

DEBUG=true
CORS_ORIGINS=["http://localhost:5173","http://localhost:3000"]

ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
CSRF_TOKEN_EXPIRE_SECONDS=3600

MAX_UPLOAD_SIZE=10485760
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/webp,image/gif

RATE_LIMIT_REQUESTS=60
RATE_LIMIT_PERIOD=60
EOL

echo "‚úÖ Backend setup complete!"

echo "üîß Setting up frontend..."
cd ../frontend

npm init -y

echo "üì¶ Installing Node.js dependencies..."
npm install react react-dom react-router-dom axios react-icons date-fns
npm install -D @types/react @types/react-dom @vitejs/plugin-react autoprefixer eslint postcss tailwindcss vite

echo "üîê Creating frontend .env file..."
cat > .env << EOL
VITE_API_URL=http://localhost:8000
VITE_APP_NAME=Closet.IA
VITE_APP_VERSION=1.0.0

VITE_ENABLE_HTTPS=false
VITE_STRICT_TRANSPORT_SECURITY=true
VITE_CONTENT_SECURITY_POLICY=true

VITE_ENABLE_ANALYTICS=false
VITE_ENABLE_DEBUG=true
EOL

echo "‚úÖ Frontend setup complete!"

echo "üîê Generating SSL certificates for development..."
cd ../backend
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes -subj "/C=BR/ST=Sao Paulo/L=Sao Paulo/O=Closet.IA/CN=localhost"

echo "üéâ Setup complete!"
echo ""
echo "To start the application:"
echo "1. Backend: cd closset-ia/backend && source venv/bin/activate && python app.py"
echo "2. Frontend: cd closset-ia/frontend && npm run dev"
echo ""
echo "Access the application at:"
echo "   Frontend: http://localhost:5173"
echo "   Backend API: http://localhost:8000"
echo "   API Docs: http://localhost:8000/api/docs"
echo ""
echo "Demo credentials:"
echo "   Email: demo@closset.com"
echo "   Password: Demo@123"
4.2 README_SECURITY.md - Documenta√ß√£o de seguran√ßa
markdown
Copy
Download

This document describes the security features implemented in Closet.IA.


- **JWT Tokens**: Secure token-based authentication
- **Refresh Tokens**: Automatic token refresh mechanism
- **Session Management**: Track and manage user sessions
- **Role-based access**: User-specific data isolation

- **CSRF Tokens**: Unique tokens for each session
- **Token Validation**: Validated on all state-changing requests
- **Origin Verification**: Check request origins
- **Double Submit Cookies**: Additional validation layer

- **Rate Limiting**: Prevent brute force attacks
- **Request Validation**: Strict input validation
- **Content Security Policy**: Prevent XSS attacks
- **Security Headers**: Modern security headers

- **Password Hashing**: bcrypt with proper truncation
- **Data Encryption**: Sensitive data encryption
- **SQL Injection Prevention**: Parameterized queries
- **File Upload Security**: Size and type validation


Create a `.env` file in the backend directory:

SECRET_KEY=your-jwt-secret-key-here
CSRF_SECRET_KEY=your-csrf-secret-key-here
DATABASE_URL=sqlite:///./closset.db
DEBUG=false
Generate Secure Keys
Copy
Download
openssl rand -hex 32

openssl rand -hex 32
üöÄ Deployment Security Checklist
Production Checklist

Change all default secrets

Enable HTTPS

Set DEBUG=false

Configure proper CORS origins

Set up proper database (PostgreSQL)

Enable request logging

Set up monitoring and alerts

Regular security updates

SSL/TLS Configuration
nginx
Copy
Download
server {
    listen 443 ssl http2;
    server_name closset.ia;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
    }
}
üêõ Security Testing
Manual Testing

CSRF Protection: Try to submit forms without CSRF token

Rate Limiting: Send multiple rapid requests

XSS Prevention: Try to inject scripts in input fields

SQL Injection: Try SQL injection in API parameters

Automated Testing
Copy
Download
pip install bandit safety

bandit -r backend/
safety check

npm audit
üìû Security Incident Response
Incident Report Template
text
Copy
Download
1. Incident Summary
2. Date/Time of Discovery
3. Affected Systems
4. Impact Assessment
5. Immediate Actions Taken
6. Root Cause Analysis
7. Remediation Steps
8. Prevention Measures
Emergency Contacts

Security Team: security@closset.ia

Infrastructure: infra@closset.ia

Legal: legal@closset.ia

üìö References
OWASP Top 10 Protection

A01:2021-Broken Access Control: JWT + Session management

A02:2021-Cryptographic Failures: bcrypt + HTTPS

A03:2021-Injection: SQLAlchemy ORM

A05:2021-Security Misconfiguration: Secure defaults

A07:2021-Identification and Authentication Failures: Strong auth

A08:2021-Software and Data Integrity Failures: CSRF protection

Compliance

GDPR: User data protection

LGPD: Brazilian data protection

ISO 27001: Information security

text
Copy
Download

---


import pytest
from fastapi.testclient import TestClient
from datetime import datetime, timedelta
import json

from app import app
from security import (
    create_access_token,
    create_refresh_token,
    verify_access_token,
    verify_refresh_token,
    generate_csrf_token,
    validate_csrf_token
)

client = TestClient(app)

def test_csrf_protection():
    """Test CSRF protection on POST requests"""
    register_response = client.post("/api/auth/register", json={
        "username": "testuser",
        "email": "test@example.com",
        "password": "Test@12345"
    })
    assert register_response.status_code == 200

    access_token = register_response.json()["access_token"]
    csrf_token = register_response.json()["csrf_token"]

    response = client.put(
        "/api/profile",
        json={"style_preference": "modern"},
        headers={"Authorization": f"Bearer {access_token}"}
    )
    assert response.status_code == 403
    assert "CSRF" in response.json()["detail"]

    response = client.put(
        "/api/profile",
        json={"style_preference": "modern"},
        headers={
            "Authorization": f"Bearer {access_token}",
            "X-CSRF-Token": "invalid-token"
        }
    )
    assert response.status_code == 403

    response = client.put(
        "/api/profile",
        json={"style_preference": "modern"},
        headers={
            "Authorization": f"Bearer {access_token}",
            "X-CSRF-Token": csrf_token
        }
    )
    assert response.status_code == 200

def test_jwt_token_security():
    """Test JWT token validation and expiration"""
    user_id = "test-user-id"
    access_token = create_access_token({"sub": user_id})
    refresh_token = create_refresh_token({"sub": user_id})

    access_data = verify_access_token(access_token)
    assert access_data is not None
    assert access_data["sub"] == user_id
    assert access_data["type"] == "access"

    refresh_data = verify_refresh_token(refresh_token)
    assert refresh_data is not None
    assert refresh_data["sub"] == user_id
    assert refresh_data["type"] == "refresh"

    expired_token = create_access_token(
        {"sub": user_id},
        expires_delta=timedelta(seconds=-1)  # Expired 1 second ago
    )
    expired_data = verify_access_token(expired_token)
    assert expired_data is None

    invalid_token = access_token[:-5] + "xxxxx"
    invalid_data = verify_access_token(invalid_token)
    assert invalid_data is None

def test_rate_limiting():
    """Test rate limiting functionality"""
    responses = []
    for i in range(65):  # More than the 60 requests/minute limit
        response = client.get("/api/health")
        responses.append(response.status_code)

    assert 429 in responses

def test_password_security():
    """Test password strength requirements"""
    response = client.post("/api/auth/register", json={
        "username": "weakuser",
        "email": "weak@example.com",
        "password": "weak"
    })
    assert response.status_code == 422  # Validation error

    response = client.post("/api/auth/register", json={
        "username": "nouppercase",
        "email": "noupper@example.com",
        "password": "test12345"
    })
    assert response.status_code == 422

    response = client.post("/api/auth/register", json={
        "username": "nonumbers",
        "email": "nonum@example.com",
        "password": "TestPassword"
    })
    assert response.status_code == 422

    response = client.post("/api/auth/register", json={
        "username": "stronguser",
        "email": "strong@example.com",
        "password": "Strong@12345"
    })
    assert response.status_code == 200

def test_session_management():
    """Test session creation and management"""
    register_response = client.post("/api/auth/register", json={
        "username": "sessionuser",
        "email": "session@example.com",
        "password": "Session@12345"
    })
    assert register_response.status_code == 200

    access_token = register_response.json()["access_token"]

    response = client.get(
        "/api/auth/sessions",
        headers={"Authorization": f"Bearer {access_token}"}
    )
    assert response.status_code == 200
    sessions = response.json()["sessions"]
    assert len(sessions) > 0

    response = client.post(
        "/api/auth/logout",
        headers={"Authorization": f"Bearer {access_token}"}
    )
    assert response.status_code == 200

    response = client.get(
        "/api/profile",
        headers={"Authorization": f"Bearer {access_token}"}
    )
    assert response.status_code == 401

def test_file_upload_security():
    """Test file upload security restrictions"""
    large_file = b"x" * (11 * 1024 * 1024)  # 11MB > 10MB limit

    response = client.post(
        "/api/closet/upload",
        files={"file": ("large.jpg", large_file, "image/jpeg")},
        data={"category": "top"},
        headers={"Authorization": "Bearer faketoken"}  # Need proper token in real test
    )
    assert response.status_code in [401, 413]

    invalid_file = b"fake content"

    response = client.post(
        "/api/closet/upload",
        files={"file": ("test.txt", invalid_file, "text/plain")},
        data={"category": "top"},
        headers={"Authorization": "Bearer faketoken"}
    )
    assert response.status_code in [401, 415]

def test_origin_validation():
    """Test request origin validation"""
    response = client.get(
        "/api/health",
        headers={"Origin": "https://malicious-site.com"}
    )

    response = client.get(
        "/api/health",
        headers={"Origin": "http://localhost:5173"}
    )
    assert response.status_code == 200

if __name__ == "__main__":
    pytest.main([__file__, "-v"])
6. RESUMO DAS MELHORIAS DE SEGURAN√áA IMPLEMENTADAS
‚úÖ Prote√ß√£o CSRF Completa:

Tokens CSRF √∫nicos por sess√£o

Valida√ß√£o em todas as requisi√ß√µes n√£o-GET

HMAC adicional para seguran√ßa extra

Expira√ß√£o configur√°vel (1 hora padr√£o)

Endpoints para gerenciamento de tokens

‚úÖ Seguran√ßa JWT Aprimorada:

Tokens de acesso (30 minutos)

Tokens de refresh (7 dias)

Unique JWT IDs (jti) para replay protection

Valida√ß√£o de tipo de token (access/refresh)

Blacklisting de tokens via sess√µes

‚úÖ Gerenciamento de Sess√µes:

Rastreamento de m√∫ltiplas sess√µes por usu√°rio

Revoga√ß√£o individual de sess√µes

Informa√ß√µes de dispositivo e localiza√ß√£o

Tempo de atividade autom√°tico

‚úÖ Prote√ß√£o de Requisi√ß√µes:

Rate limiting por IP (60 req/min)

Valida√ß√£o de origem das requisi√ß√µes

Security headers (CSP, HSTS, X-Frame, etc.)

Request ID para tracing

‚úÖ Valida√ß√£o de Dados:

Valida√ß√£o de for√ßa de senha

Limites de tamanho de upload (10MB)

Valida√ß√£o de tipos de arquivo

Sanitiza√ß√£o de nomes de arquivo

‚úÖ Arquitetura Segura:

Configura√ß√µes via vari√°veis de ambiente

Separa√ß√£o de ambientes (dev/prod)

Logs de auditoria de seguran√ßa

Scripts de setup automatizados

‚úÖ Recupera√ß√£o e Resili√™ncia:

Refresh token autom√°tico

Fallback para CSRF token

Limpeza autom√°tica de tokens inv√°lidos

Redirecionamento para login em erros de auth

‚úÖ Monitoramento:

Endpoint de sa√∫de com status de seguran√ßa

Listagem de sess√µes ativas

Logs de auditoria

Rate limiting vis√≠vel

7. COMO TESTAR A SEGURAN√áA
Testes Manuais:
Copy
Download
curl -X PUT http://localhost:8000/api/profile \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"style_preference": "modern"}'

for i in {1..70}; do curl http://localhost:8000/api/health; done

curl -X GET http://localhost:8000/api/profile \
  -H "Authorization: Bearer <expired_token>"

curl -X POST http://localhost:8000/api/closet/upload \
  -H "Authorization: Bearer <token>" \
  -F "file=@large_file.jpg" \
  -F "category=top"
Testes Automatizados:
Copy
Download
pip install pytest httpx

cd backend
pytest tests/test_security.py -v

pip-audit
npm audit
8. DEPLOY SEGURO EM PRODU√á√ÉO
Passos para Production:

Altere todas as chaves secretas

Configure HTTPS com certificados v√°lidos

Desative modo DEBUG

Configure CORS apenas para seus dom√≠nios

Use banco de dados PostgreSQL

Configure logging e monitoring

Implemente WAF (Web Application Firewall)

Fa√ßa backup regular dos dados

Monitore logs de seguran√ßa

Fa√ßa pentest regularmente

O sistema agora est√° completamente protegido com CSRF, JWT, rate limiting, valida√ß√£o de origem e todas as melhores pr√°ticas de seguran√ßa modernas.

preciso que esse c√≥digo tenha ao menos 7 telas, as telas modelo j√° est√£o prontas e s√£o essas da imagem que irei anexar abaixo, meu plano era rodar esse site via devtunneling ou algo similar. a descri√ß√£o de cada p√°gina √©: 7 telas de layout do site da Closet.IA, em formato de **prot√≥tipo preliminar, alinhadas √† apresenta√ß√£o, ao BMC e inspiradas no **Acloset*, mas com identidade pr√≥pria e foco em IA estrat√©gica e consumo consciente. --- ## 1Ô∏è‚É£ Tela de Login / Cadastro *Objetivo:* Entrada r√°pida e simples no ecossistema Closet.IA *Elementos do layout:* * Logo + slogan: ‚ÄúCloset.IA ‚Äì intelig√™ncia que veste voc√™‚Äù * Login com: * E-mail e senha * Google / Apple / LinkedIn (foco profissional) * CTA: *‚ÄúCriar conta gratuitamente‚Äù* * Texto curto de valor: > ‚ÄúOrganize seu guarda-roupa, crie looks inteligentes e compre melhor.‚Äù *Diferencial:* Comunica√ß√£o direta de benef√≠cio logo na entrada. --- ## 2Ô∏è‚É£ Tela de Informa√ß√µes Pessoais & Perfil de Estilo *Objetivo:* Coletar dados para personaliza√ß√£o da IA *Campos e se√ß√µes:* * Informa√ß√µes f√≠sicas (opcional e edit√°vel): * Altura * Peso * Tipo de corpo * Identidade e prefer√™ncias: * G√™nero (aberto / customiz√°vel) * Estilo predominante (cl√°ssico, casual, criativo, corporativo, etc.) * Ambiente mais frequente (trabalho, eventos, dia a dia) * An√°lise visual: * Tom de pele * Subtom (quente, frio, neutro) * CTA: *‚ÄúContinuar e montar meu closet digital‚Äù* *Diferencial:* Sens√≠vel √† diversidade e focada em identidade, n√£o padr√£o. --- ## 3Ô∏è‚É£ Tela de Upload & Digitaliza√ß√£o do Guarda-Roupa *Objetivo:* Cadastrar roupas com o m√≠nimo de esfor√ßo *Elementos do layout:* * Bot√£o central: *‚ÄúAdicionar roupas‚Äù* * Op√ß√µes: * Upload m√∫ltiplo de fotos * Tirar foto pelo celular * Fun√ß√£o IA: * Remo√ß√£o autom√°tica de fundo * Classifica√ß√£o da pe√ßa (tipo, cor, tecido, ocasi√£o) * Feedback visual: * ‚Äú5 pe√ßas adicionadas com sucesso‚Äù * Organiza√ß√£o por categorias: * Partes de cima / baixo / cal√ßados / acess√≥rios *Diferencial:* Redu√ß√£o do atrito (scanner inteligente). --- ## 4Ô∏è‚É£ Tela de Looks Inteligentes (Home Principal) *Objetivo:* Resolver o problema do ‚Äún√£o sei o que vestir‚Äù *Elementos do layout:* * Sauda√ß√£o personalizada: > ‚ÄúBom dia, Larissa. Hoje faz 24¬∞C e voc√™ tem uma reuni√£o.‚Äù * Sugest√µes autom√°ticas de looks: * Look do dia * Look alternativo * Filtros r√°pidos: * Clima * Ocasi√£o * Estilo * Bot√µes: * ‚ÄúSalvar look‚Äù * ‚ÄúEditar combina√ß√£o‚Äù * ‚ÄúVer pe√ßas usadas‚Äù *Diferencial:* Contexto (clima + agenda + estilo). --- ## 5Ô∏è‚É£ Tela de Chat com a IA (Stylist Digital) *Objetivo:* Intera√ß√£o conversacional e consultiva *Layout:* * Chat estilo WhatsApp/ChatGPT * Exemplos de comandos: * ‚ÄúMonte um look para entrevista‚Äù * ‚ÄúO que posso usar com essa cal√ßa?‚Äù * ‚ÄúO que falta no meu guarda-roupa?‚Äù * Respostas da IA: * Looks visuais * Dicas de estilo * Alertas conscientes: > ‚ÄúVoc√™ j√° tem 3 pe√ßas similares a essa.‚Äù *Diferencial:* IA como assistente financeiro e de imagem. --- ## 6Ô∏è‚É£ Tela de Compras Inteligentes & Recomenda√ß√µes *Objetivo:* Monetiza√ß√£o + consumo consciente *Elementos do layout:* * Se√ß√£o: *‚ÄúO que vale a pena comprar agora‚Äù* * Recomenda√ß√µes baseadas em gaps reais: * ‚ÄúEssa pe√ßa criaria 6 novos looks‚Äù * Integra√ß√£o com e-commerces parceiros * Filtros: * Pre√ßo * Sustentabilidade * Marca * Aviso transparente: > ‚ÄúRecomenda√ß√£o baseada no seu guarda-roupa atual.‚Äù *Diferencial:* Compra direcionada, n√£o impulsiva. --- ## 7Ô∏è‚É£ Tela de Descoberta de Cores & Prova Virtual *Objetivo:* Autoconhecimento e experi√™ncia premium *Funcionalidades:* * Descobrir minhas cores: * Paleta ideal (inverno, ver√£o, outono, primavera) * Cores que valorizam e que devem ser evitadas * Prova virtual: * Simula√ß√£o de looks no corpo * Visualiza√ß√£o de cores diferentes na mesma pe√ßa * CTA premium: * ‚ÄúDesbloquear consultoria avan√ßada‚Äù *Diferencial:* Experi√™ncia visual + valor percebido alto. --- ### üîπ Resumo Estrat√©gico Essas 7 telas: * Resolvem dores reais (tempo, indecis√£o, excesso) * Conectam *IA + estilo + sustentabilidade* * Sustentam o modelo freemium + afiliados * Mant√™m coer√™ncia total com a apresenta√ß√£o da Closet.IA quero um c√≥digo limpo , funcional e profissional.